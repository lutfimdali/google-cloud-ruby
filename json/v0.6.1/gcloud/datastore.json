{"id":"datastore","metadata":{"name":"Datastore","description":"<h1 id=\"google-cloud-datastore\">Google Cloud Datastore</h1>  <p>Google Cloud Datastore is a fully managed, schemaless database for storing non-relational data. You should feel at home if you are familiar with relational databases, but there are some key differences to be aware of to make the most of using Datastore.</p>  <p>Gcloud’s goal is to provide a API that is familiar and comfortable to Rubyists. Authentication is handled by Gcloud#datastore. You can provide the project and credential information to connect to the Datastore service, or if you are running on Google Compute Engine this configuration is taken care of for you.</p>  <div class=\"highlighter-rouge\"><pre class=\"ruby\"><code><span class=\"nb\">require</span> <span class=\"s2\">\"gcloud\"</span>  <span class=\"n\">gcloud</span> <span class=\"o\">=</span> <span class=\"no\">Gcloud</span><span class=\"p\">.</span><span class=\"nf\">new</span> <span class=\"s2\">\"my-todo-project\"</span><span class=\"p\">,</span>                     <span class=\"s2\">\"/path/to/keyfile.json\"</span> <span class=\"n\">dataset</span> <span class=\"o\">=</span> <span class=\"n\">gcloud</span><span class=\"p\">.</span><span class=\"nf\">datastore</span> <span class=\"n\">entity</span> <span class=\"o\">=</span> <span class=\"n\">dataset</span><span class=\"p\">.</span><span class=\"nf\">find</span> <span class=\"s2\">\"Task\"</span><span class=\"p\">,</span> <span class=\"s2\">\"start\"</span> <span class=\"n\">entity</span><span class=\"p\">[</span><span class=\"s2\">\"completed\"</span><span class=\"p\">]</span> <span class=\"o\">=</span> <span class=\"kp\">true</span> <span class=\"n\">dataset</span><span class=\"p\">.</span><span class=\"nf\">save</span> <span class=\"n\">entity</span> </code></pre> </div>  <p>You can learn more about various options for connection on the <a href=\"../AUTHENTICATION\">Authentication Guide</a>.</p>  <p>To learn more about Datastore, read the <a href=\"https://cloud.google.com/datastore/docs/concepts/overview\">Google Cloud Datastore Concepts Overview </a>.</p>  <h2 id=\"retrieving-records\">Retrieving Records</h2>  <p>Records, called “entities” in Datastore, are retrieved by using a Key. The Key is more than a numeric identifier, it is a complex data structure that can be used to model relationships. The simplest Key has a string <tt>kind</tt> value, and either a numeric <tt>id</tt> value, or a string <tt>name</tt> value. A single record can be retrieved by calling Gcloud::Datastore::Dataset#find and passing the parts of the key:</p>  <div class=\"highlighter-rouge\"><pre class=\"ruby\"><code><span class=\"nb\">require</span> <span class=\"s2\">\"gcloud\"</span>  <span class=\"n\">gcloud</span> <span class=\"o\">=</span> <span class=\"no\">Gcloud</span><span class=\"p\">.</span><span class=\"nf\">new</span> <span class=\"n\">dataset</span> <span class=\"o\">=</span> <span class=\"n\">gcloud</span><span class=\"p\">.</span><span class=\"nf\">datastore</span> <span class=\"n\">entity</span> <span class=\"o\">=</span> <span class=\"n\">dataset</span><span class=\"p\">.</span><span class=\"nf\">find</span> <span class=\"s2\">\"Task\"</span><span class=\"p\">,</span> <span class=\"s2\">\"start\"</span> </code></pre> </div>  <p>Optionally, Gcloud::Datastore::Dataset#find can be given a Key object:</p>  <div class=\"highlighter-rouge\"><pre class=\"ruby\"><code><span class=\"nb\">require</span> <span class=\"s2\">\"gcloud\"</span>  <span class=\"n\">gcloud</span> <span class=\"o\">=</span> <span class=\"no\">Gcloud</span><span class=\"p\">.</span><span class=\"nf\">new</span> <span class=\"n\">dataset</span> <span class=\"o\">=</span> <span class=\"n\">gcloud</span><span class=\"p\">.</span><span class=\"nf\">datastore</span> <span class=\"n\">key</span> <span class=\"o\">=</span> <span class=\"n\">dataset</span><span class=\"p\">.</span><span class=\"nf\">key</span> <span class=\"s2\">\"Task\"</span><span class=\"p\">,</span> <span class=\"mi\">12345</span> <span class=\"n\">entity</span> <span class=\"o\">=</span> <span class=\"n\">dataset</span><span class=\"p\">.</span><span class=\"nf\">find</span> <span class=\"n\">key</span> </code></pre> </div>  <p>See Gcloud::Datastore::Dataset#find</p>  <h2 id=\"querying-records\">Querying Records</h2>  <p>Multiple records can be found that match criteria. (See Gcloud::Datastore::Query#where)</p>  <div class=\"highlighter-rouge\"><pre class=\"ruby\"><code><span class=\"nb\">require</span> <span class=\"s2\">\"gcloud\"</span>  <span class=\"n\">gcloud</span> <span class=\"o\">=</span> <span class=\"no\">Gcloud</span><span class=\"p\">.</span><span class=\"nf\">new</span> <span class=\"n\">dataset</span> <span class=\"o\">=</span> <span class=\"n\">gcloud</span><span class=\"p\">.</span><span class=\"nf\">datastore</span> <span class=\"n\">query</span> <span class=\"o\">=</span> <span class=\"n\">dataset</span><span class=\"p\">.</span><span class=\"nf\">query</span><span class=\"p\">(</span><span class=\"s2\">\"List\"</span><span class=\"p\">).</span>   <span class=\"nf\">where</span><span class=\"p\">(</span><span class=\"s2\">\"active\"</span><span class=\"p\">,</span> <span class=\"s2\">\"=\"</span><span class=\"p\">,</span> <span class=\"kp\">true</span><span class=\"p\">)</span> <span class=\"n\">active_lists</span> <span class=\"o\">=</span> <span class=\"n\">dataset</span><span class=\"p\">.</span><span class=\"nf\">run</span> <span class=\"n\">query</span> </code></pre> </div>  <p>Records can also be ordered. (See Gcloud::Datastore::Query#order)</p>  <div class=\"highlighter-rouge\"><pre class=\"ruby\"><code><span class=\"nb\">require</span> <span class=\"s2\">\"gcloud\"</span>  <span class=\"n\">gcloud</span> <span class=\"o\">=</span> <span class=\"no\">Gcloud</span><span class=\"p\">.</span><span class=\"nf\">new</span> <span class=\"n\">dataset</span> <span class=\"o\">=</span> <span class=\"n\">gcloud</span><span class=\"p\">.</span><span class=\"nf\">datastore</span> <span class=\"n\">query</span> <span class=\"o\">=</span> <span class=\"n\">dataset</span><span class=\"p\">.</span><span class=\"nf\">query</span><span class=\"p\">(</span><span class=\"s2\">\"List\"</span><span class=\"p\">).</span>   <span class=\"nf\">where</span><span class=\"p\">(</span><span class=\"s2\">\"active\"</span><span class=\"p\">,</span> <span class=\"s2\">\"=\"</span><span class=\"p\">,</span> <span class=\"kp\">true</span><span class=\"p\">).</span>   <span class=\"nf\">order</span><span class=\"p\">(</span><span class=\"s2\">\"name\"</span><span class=\"p\">)</span> <span class=\"n\">active_lists</span> <span class=\"o\">=</span> <span class=\"n\">dataset</span><span class=\"p\">.</span><span class=\"nf\">run</span> <span class=\"n\">query</span> </code></pre> </div>  <p>The number of records returned can be specified. (See Gcloud::Datastore::Query#limit)</p>  <div class=\"highlighter-rouge\"><pre class=\"ruby\"><code><span class=\"nb\">require</span> <span class=\"s2\">\"gcloud\"</span>  <span class=\"n\">gcloud</span> <span class=\"o\">=</span> <span class=\"no\">Gcloud</span><span class=\"p\">.</span><span class=\"nf\">new</span> <span class=\"n\">dataset</span> <span class=\"o\">=</span> <span class=\"n\">gcloud</span><span class=\"p\">.</span><span class=\"nf\">datastore</span> <span class=\"n\">query</span> <span class=\"o\">=</span> <span class=\"n\">dataset</span><span class=\"p\">.</span><span class=\"nf\">query</span><span class=\"p\">(</span><span class=\"s2\">\"List\"</span><span class=\"p\">).</span>   <span class=\"nf\">where</span><span class=\"p\">(</span><span class=\"s2\">\"active\"</span><span class=\"p\">,</span> <span class=\"s2\">\"=\"</span><span class=\"p\">,</span> <span class=\"kp\">true</span><span class=\"p\">).</span>   <span class=\"nf\">order</span><span class=\"p\">(</span><span class=\"s2\">\"name\"</span><span class=\"p\">).</span>   <span class=\"nf\">limit</span><span class=\"p\">(</span><span class=\"mi\">5</span><span class=\"p\">)</span> <span class=\"n\">active_lists</span> <span class=\"o\">=</span> <span class=\"n\">dataset</span><span class=\"p\">.</span><span class=\"nf\">run</span> <span class=\"n\">query</span> </code></pre> </div>  <p>Records’ Key structures can also be queried. (See Gcloud::Datastore::Query#ancestor)</p>  <div class=\"highlighter-rouge\"><pre class=\"ruby\"><code><span class=\"nb\">require</span> <span class=\"s2\">\"gcloud\"</span>  <span class=\"n\">gcloud</span> <span class=\"o\">=</span> <span class=\"no\">Gcloud</span><span class=\"p\">.</span><span class=\"nf\">new</span> <span class=\"n\">dataset</span> <span class=\"o\">=</span> <span class=\"n\">gcloud</span><span class=\"p\">.</span><span class=\"nf\">datastore</span>  <span class=\"n\">list</span> <span class=\"o\">=</span> <span class=\"n\">dataset</span><span class=\"p\">.</span><span class=\"nf\">find</span> <span class=\"s2\">\"List\"</span><span class=\"p\">,</span> <span class=\"s2\">\"todos\"</span> <span class=\"n\">query</span> <span class=\"o\">=</span> <span class=\"n\">dataset</span><span class=\"p\">.</span><span class=\"nf\">query</span><span class=\"p\">(</span><span class=\"s2\">\"Task\"</span><span class=\"p\">).</span>   <span class=\"nf\">ancestor</span><span class=\"p\">(</span><span class=\"n\">list</span><span class=\"p\">.</span><span class=\"nf\">key</span><span class=\"p\">)</span> <span class=\"n\">items</span> <span class=\"o\">=</span> <span class=\"n\">dataset</span><span class=\"p\">.</span><span class=\"nf\">run</span> <span class=\"n\">query</span> </code></pre> </div>  <p>See Gcloud::Datastore::Query and Gcloud::Datastore::Dataset#run</p>  <h2 id=\"paginating-records\">Paginating Records</h2>  <p>All Records may not return at once, requiring multiple calls to Datastore to return them all. The returned records will have a <tt>cursor</tt> if there are more available.</p>  <div class=\"highlighter-rouge\"><pre class=\"ruby\"><code><span class=\"nb\">require</span> <span class=\"s2\">\"gcloud\"</span>  <span class=\"n\">gcloud</span> <span class=\"o\">=</span> <span class=\"no\">Gcloud</span><span class=\"p\">.</span><span class=\"nf\">new</span> <span class=\"n\">dataset</span> <span class=\"o\">=</span> <span class=\"n\">gcloud</span><span class=\"p\">.</span><span class=\"nf\">datastore</span>  <span class=\"n\">list</span> <span class=\"o\">=</span> <span class=\"n\">dataset</span><span class=\"p\">.</span><span class=\"nf\">find</span> <span class=\"s2\">\"List\"</span><span class=\"p\">,</span> <span class=\"s2\">\"todos\"</span> <span class=\"n\">query</span> <span class=\"o\">=</span> <span class=\"n\">dataset</span><span class=\"p\">.</span><span class=\"nf\">query</span><span class=\"p\">(</span><span class=\"s2\">\"Task\"</span><span class=\"p\">).</span>   <span class=\"nf\">ancestor</span><span class=\"p\">(</span><span class=\"n\">list</span><span class=\"p\">.</span><span class=\"nf\">key</span><span class=\"p\">)</span> <span class=\"n\">all_tasks</span> <span class=\"o\">=</span> <span class=\"p\">[]</span> <span class=\"n\">tmp_tasks</span> <span class=\"o\">=</span> <span class=\"n\">dataset</span><span class=\"p\">.</span><span class=\"nf\">run</span> <span class=\"n\">query</span> <span class=\"k\">while</span> <span class=\"n\">tmp_tasks</span><span class=\"p\">.</span><span class=\"nf\">any?</span> <span class=\"k\">do</span>   <span class=\"n\">tmp_tasks</span><span class=\"p\">.</span><span class=\"nf\">each</span> <span class=\"k\">do</span> <span class=\"o\">|</span><span class=\"n\">task</span><span class=\"o\">|</span>     <span class=\"n\">all_tasks</span> <span class=\"o\">&lt;&lt;</span> <span class=\"n\">task</span>   <span class=\"k\">end</span>   <span class=\"c1\"># break loop if no more tasks available</span>   <span class=\"k\">break</span> <span class=\"k\">if</span> <span class=\"n\">tmp_tasks</span><span class=\"p\">.</span><span class=\"nf\">cursor</span><span class=\"p\">.</span><span class=\"nf\">nil?</span>   <span class=\"c1\"># set cursor on the query</span>   <span class=\"n\">query</span> <span class=\"o\">=</span> <span class=\"n\">query</span><span class=\"p\">.</span><span class=\"nf\">cursor</span> <span class=\"n\">tmp_tasks</span><span class=\"p\">.</span><span class=\"nf\">cursor</span>   <span class=\"c1\"># query for more records</span>   <span class=\"n\">tmp_tasks</span> <span class=\"o\">=</span> <span class=\"n\">dataset</span><span class=\"p\">.</span><span class=\"nf\">run</span> <span class=\"n\">query</span> <span class=\"k\">end</span> </code></pre> </div>  <p>See Gcloud::Datastore::Dataset::LookupResults and Gcloud::Datastore::Dataset::QueryResults</p>  <h2 id=\"creating-records\">Creating Records</h2>  <p>New entities can be created and persisted buy calling Dataset#save. The entity must have a Key to be saved. If the Key is incomplete then it will be completed when saved.</p>  <div class=\"highlighter-rouge\"><pre class=\"ruby\"><code><span class=\"nb\">require</span> <span class=\"s2\">\"gcloud\"</span>  <span class=\"n\">gcloud</span> <span class=\"o\">=</span> <span class=\"no\">Gcloud</span><span class=\"p\">.</span><span class=\"nf\">new</span> <span class=\"n\">dataset</span> <span class=\"o\">=</span> <span class=\"n\">gcloud</span><span class=\"p\">.</span><span class=\"nf\">datastore</span> <span class=\"n\">entity</span> <span class=\"o\">=</span> <span class=\"n\">dataset</span><span class=\"p\">.</span><span class=\"nf\">entity</span> <span class=\"s2\">\"User\"</span> <span class=\"k\">do</span> <span class=\"o\">|</span><span class=\"n\">e</span><span class=\"o\">|</span>   <span class=\"n\">e</span><span class=\"p\">[</span><span class=\"s2\">\"name\"</span><span class=\"p\">]</span> <span class=\"o\">=</span> <span class=\"s2\">\"Heidi Henderson\"</span> <span class=\"k\">end</span> <span class=\"n\">entity</span><span class=\"p\">.</span><span class=\"nf\">key</span><span class=\"p\">.</span><span class=\"nf\">id</span> <span class=\"c1\">#=&gt; nil</span> <span class=\"n\">dataset</span><span class=\"p\">.</span><span class=\"nf\">save</span> <span class=\"n\">entity</span> <span class=\"n\">entity</span><span class=\"p\">.</span><span class=\"nf\">key</span><span class=\"p\">.</span><span class=\"nf\">id</span> <span class=\"c1\">#=&gt; 123456789</span> </code></pre> </div>  <h2 id=\"updating-records\">Updating Records</h2>  <p>Entities hold properties. A property has a name that is a string or symbol, and a value that is an object. Most value objects are supported, including String, Integer, Date, Time, and even other Entity or Key objects. Changes to the Entity’s properties are persisted by calling Dataset#save.</p>  <div class=\"highlighter-rouge\"><pre class=\"ruby\"><code><span class=\"nb\">require</span> <span class=\"s2\">\"gcloud\"</span>  <span class=\"n\">gcloud</span> <span class=\"o\">=</span> <span class=\"no\">Gcloud</span><span class=\"p\">.</span><span class=\"nf\">new</span> <span class=\"n\">dataset</span> <span class=\"o\">=</span> <span class=\"n\">gcloud</span><span class=\"p\">.</span><span class=\"nf\">datastore</span> <span class=\"n\">entity</span> <span class=\"o\">=</span> <span class=\"n\">dataset</span><span class=\"p\">.</span><span class=\"nf\">find</span> <span class=\"s2\">\"User\"</span><span class=\"p\">,</span> <span class=\"s2\">\"heidi\"</span> <span class=\"c1\"># Read the status property</span> <span class=\"n\">entity</span><span class=\"p\">[</span><span class=\"s2\">\"status\"</span><span class=\"p\">]</span> <span class=\"c1\">#=&gt; \"inactive\"</span> <span class=\"c1\"># Write the status property</span> <span class=\"n\">entity</span><span class=\"p\">[</span><span class=\"s2\">\"status\"</span><span class=\"p\">]</span> <span class=\"o\">=</span> <span class=\"s2\">\"active\"</span> <span class=\"c1\"># Persist the changes</span> <span class=\"n\">dataset</span><span class=\"p\">.</span><span class=\"nf\">save</span> <span class=\"n\">entity</span> </code></pre> </div>  <h2 id=\"deleting-records\">Deleting Records</h2>  <p>Entities can be removed from Datastore by calling Dataset#delete and passing the Entity object or the entity’s Key object.</p>  <div class=\"highlighter-rouge\"><pre class=\"ruby\"><code><span class=\"nb\">require</span> <span class=\"s2\">\"gcloud\"</span>  <span class=\"n\">gcloud</span> <span class=\"o\">=</span> <span class=\"no\">Gcloud</span><span class=\"p\">.</span><span class=\"nf\">new</span> <span class=\"n\">dataset</span> <span class=\"o\">=</span> <span class=\"n\">gcloud</span><span class=\"p\">.</span><span class=\"nf\">datastore</span> <span class=\"n\">entity</span> <span class=\"o\">=</span> <span class=\"n\">dataset</span><span class=\"p\">.</span><span class=\"nf\">find</span> <span class=\"s2\">\"User\"</span><span class=\"p\">,</span> <span class=\"s2\">\"heidi\"</span> <span class=\"n\">dataset</span><span class=\"p\">.</span><span class=\"nf\">delete</span> <span class=\"n\">entity</span> </code></pre> </div>  <h2 id=\"transactions\">Transactions</h2>  <p>Complex logic can be wrapped in a Transaction. All queries and updates within the Dataset#transaction block are run within the transaction scope, and will be automatically committed when the block completes.</p>  <div class=\"highlighter-rouge\"><pre class=\"ruby\"><code><span class=\"nb\">require</span> <span class=\"s2\">\"gcloud\"</span>  <span class=\"n\">gcloud</span> <span class=\"o\">=</span> <span class=\"no\">Gcloud</span><span class=\"p\">.</span><span class=\"nf\">new</span> <span class=\"n\">dataset</span> <span class=\"o\">=</span> <span class=\"n\">gcloud</span><span class=\"p\">.</span><span class=\"nf\">datastore</span>  <span class=\"n\">key</span> <span class=\"o\">=</span> <span class=\"n\">dataset</span><span class=\"p\">.</span><span class=\"nf\">key</span> <span class=\"s2\">\"User\"</span><span class=\"p\">,</span> <span class=\"s2\">\"heidi\"</span>  <span class=\"n\">user</span> <span class=\"o\">=</span> <span class=\"n\">dataset</span><span class=\"p\">.</span><span class=\"nf\">entity</span> <span class=\"n\">key</span> <span class=\"k\">do</span> <span class=\"o\">|</span><span class=\"n\">u</span><span class=\"o\">|</span>   <span class=\"n\">u</span><span class=\"p\">[</span><span class=\"s2\">\"name\"</span><span class=\"p\">]</span> <span class=\"o\">=</span> <span class=\"s2\">\"Heidi Henderson\"</span>   <span class=\"n\">u</span><span class=\"p\">[</span><span class=\"s2\">\"email\"</span><span class=\"p\">]</span> <span class=\"o\">=</span> <span class=\"s2\">\"heidi@example.net\"</span> <span class=\"k\">end</span>  <span class=\"n\">dataset</span><span class=\"p\">.</span><span class=\"nf\">transaction</span> <span class=\"k\">do</span> <span class=\"o\">|</span><span class=\"n\">tx</span><span class=\"o\">|</span>   <span class=\"k\">if</span> <span class=\"n\">tx</span><span class=\"p\">.</span><span class=\"nf\">find</span><span class=\"p\">(</span><span class=\"n\">user</span><span class=\"p\">.</span><span class=\"nf\">key</span><span class=\"p\">).</span><span class=\"nf\">nil?</span>     <span class=\"n\">tx</span><span class=\"p\">.</span><span class=\"nf\">save</span> <span class=\"n\">user</span>   <span class=\"k\">end</span> <span class=\"k\">end</span> </code></pre> </div>  <p>Alternatively, if no block is given the transaction object is returned allowing you to commit or rollback manually.</p>  <div class=\"highlighter-rouge\"><pre class=\"ruby\"><code><span class=\"nb\">require</span> <span class=\"s2\">\"gcloud\"</span>  <span class=\"n\">gcloud</span> <span class=\"o\">=</span> <span class=\"no\">Gcloud</span><span class=\"p\">.</span><span class=\"nf\">new</span> <span class=\"n\">dataset</span> <span class=\"o\">=</span> <span class=\"n\">gcloud</span><span class=\"p\">.</span><span class=\"nf\">datastore</span>  <span class=\"n\">key</span> <span class=\"o\">=</span> <span class=\"n\">dataset</span><span class=\"p\">.</span><span class=\"nf\">key</span> <span class=\"s2\">\"User\"</span><span class=\"p\">,</span> <span class=\"s2\">\"heidi\"</span>  <span class=\"n\">user</span> <span class=\"o\">=</span> <span class=\"n\">dataset</span><span class=\"p\">.</span><span class=\"nf\">entity</span> <span class=\"n\">key</span> <span class=\"k\">do</span> <span class=\"o\">|</span><span class=\"n\">u</span><span class=\"o\">|</span>   <span class=\"n\">u</span><span class=\"p\">[</span><span class=\"s2\">\"name\"</span><span class=\"p\">]</span> <span class=\"o\">=</span> <span class=\"s2\">\"Heidi Henderson\"</span>   <span class=\"n\">u</span><span class=\"p\">[</span><span class=\"s2\">\"email\"</span><span class=\"p\">]</span> <span class=\"o\">=</span> <span class=\"s2\">\"heidi@example.net\"</span> <span class=\"k\">end</span>  <span class=\"n\">tx</span> <span class=\"o\">=</span> <span class=\"n\">dataset</span><span class=\"p\">.</span><span class=\"nf\">transaction</span> <span class=\"k\">begin</span>   <span class=\"k\">if</span> <span class=\"n\">tx</span><span class=\"p\">.</span><span class=\"nf\">find</span><span class=\"p\">(</span><span class=\"n\">user</span><span class=\"p\">.</span><span class=\"nf\">key</span><span class=\"p\">).</span><span class=\"nf\">nil?</span>     <span class=\"n\">tx</span><span class=\"p\">.</span><span class=\"nf\">save</span> <span class=\"n\">user</span>   <span class=\"k\">end</span>   <span class=\"n\">tx</span><span class=\"p\">.</span><span class=\"nf\">commit</span> <span class=\"k\">rescue</span>   <span class=\"n\">tx</span><span class=\"p\">.</span><span class=\"nf\">rollback</span> <span class=\"k\">end</span> </code></pre> </div>  <p>See Gcloud::Datastore::Transaction and Gcloud::Datastore::Dataset#transaction</p>","source":"lib/gcloud/datastore.rb#L330","resources":[],"examples":[]},"methods":[]}